<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUNNER - Autonomous Development Board</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css">
    <!-- Theme initialization - MUST run before body renders to prevent flash -->
    <script>
        (function() {
            try {
                var savedTheme = localStorage.getItem('grinder-theme') || 'dark';
                var theme = savedTheme;
                if (savedTheme === 'system') {
                    theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }
                document.documentElement.setAttribute('data-theme', theme);
                // Add no-transitions class to prevent initial flash
                document.documentElement.classList.add('no-transitions');
            } catch (e) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <button class="sidebar-toggle" id="sidebarToggle" title="Show/hide projects">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                </svg>
            </button>
            <span class="logo-icon" id="logoIcon">‚ö°Ô∏è</span>
            <h1 class="logo">RUNNER</h1>
            <div class="selected-project-display" id="selectedProjectDisplay">
                <svg class="folder-icon-header" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.89 2 1.99 2H20c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                </svg>
                <span class="selected-project-name" id="selectedProjectName">All Projects</span>
                <div class="branch-selector hidden" id="branchSelector">
                    <button class="branch-selector-btn" id="branchSelectorBtn" title="Switch branch">
                        <svg class="branch-icon-header" viewBox="0 0 16 16" fill="currentColor" width="14" height="14">
                            <path d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.493 2.493 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25Zm-6 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Zm8.25-.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z"/>
                        </svg>
                        <span class="current-branch-name" id="currentBranchName"></span>
                        <svg class="branch-chevron" viewBox="0 0 16 16" fill="currentColor" width="12" height="12">
                            <path d="M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z"/>
                        </svg>
                    </button>
                    <button class="branch-pull-btn hidden" id="branchPullBtn" title="Pull latest changes">
                        <svg viewBox="0 0 16 16" fill="currentColor" width="14" height="14">
                            <path d="M8 4a.5.5 0 01.5.5v5.793l2.146-2.147a.5.5 0 01.708.708l-3 3a.5.5 0 01-.708 0l-3-3a.5.5 0 11.708-.708L7.5 10.293V4.5A.5.5 0 018 4z"/>
                            <path d="M3.5 1a.5.5 0 00-.5.5v1a.5.5 0 00.5.5h9a.5.5 0 00.5-.5v-1a.5.5 0 00-.5-.5h-9z"/>
                        </svg>
                    </button>
                    <div class="branch-dropdown hidden" id="branchDropdown">
                        <div class="branch-dropdown-list" id="branchDropdownList"></div>
                    </div>
                </div>
                <!-- Push Button (Trunk-based development) -->
                <button class="push-btn hidden" id="pushBtn" title="Push to remote">
                    <svg viewBox="0 0 16 16" fill="currentColor" width="14" height="14">
                        <path d="M8 12a.5.5 0 00.5-.5V5.707l2.146 2.147a.5.5 0 00.708-.708l-3-3a.5.5 0 00-.708 0l-3 3a.5.5 0 10.708.708L7.5 5.707V11.5a.5.5 0 00.5.5z"/>
                        <path d="M3.5 15a.5.5 0 00.5-.5v-1a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v1a.5.5 0 00.5.5h9z" fill-opacity="0"/>
                    </svg>
                    <span class="push-badge hidden" id="pushBadge">0</span>
                </button>
            </div>
        </div>
        <div class="header-right">
            <!-- Create PR Button -->
            <button class="btn btn-create-pr" id="btnCreatePR" title="Create Pull Request">
                <svg class="btn-icon" viewBox="0 0 16 16" fill="currentColor" width="16" height="16">
                    <path d="M1.5 3.25a2.25 2.25 0 1 1 3 2.122v5.256a2.251 2.251 0 1 1-1.5 0V5.372A2.25 2.25 0 0 1 1.5 3.25Zm5.677-.177L9.573.677A.25.25 0 0 1 10 .854V2.5h1A2.5 2.5 0 0 1 13.5 5v5.628a2.251 2.251 0 1 1-1.5 0V5a1 1 0 0 0-1-1h-1v1.646a.25.25 0 0 1-.427.177L7.177 3.427a.25.25 0 0 1 0-.354ZM3.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm0 9.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm8.25.75a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Z"/>
                </svg>
                <span>Create PR</span>
            </button>
            <!-- User Profile -->
            <div class="user-profile" id="userProfile">
                <div class="user-profile-trigger" id="userProfileTrigger">
                    <div class="user-avatar" id="userAvatar">
                        <!-- Default user silhouette SVG -->
                        <svg class="user-icon-default" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </div>
                    <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-header" id="userDropdownHeader">
                        <span class="user-dropdown-name" id="userDropdownName">Not connected</span>
                        <a class="user-dropdown-link hidden" id="userDropdownLink" href="#" target="_blank">View profile</a>
                    </div>
                    <div class="user-dropdown-divider"></div>
                    <button class="user-dropdown-item" id="btnConnectGithub">
                        <svg class="dropdown-item-icon" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/>
                        </svg>
                        Connect GitHub
                    </button>
                    <button class="user-dropdown-item" id="btnToggleTheme">
                        <svg class="dropdown-item-icon theme-icon-dark" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
                        </svg>
                        <svg class="dropdown-item-icon theme-icon-light" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 0 0-1.41 0 .996.996 0 0 0 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 0 0-1.41 0 .996.996 0 0 0 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 0 0 0-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 0 0 0-1.41.996.996 0 0 0-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 0 0 0-1.41.996.996 0 0 0-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                        </svg>
                        <span class="theme-toggle-label">Theme</span>
                    </button>
                    <button class="user-dropdown-item" id="btnOpenSettings">
                        <svg class="dropdown-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        Settings
                    </button>
                    <div class="user-dropdown-divider"></div>
                    <button class="user-dropdown-item user-dropdown-item-danger hidden" id="btnDisconnectGithub">
                        <svg class="dropdown-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Disconnect
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar Overlay (for dimming background) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Mobile Column Tabs (visible only on mobile, positioned below header) -->
    <div class="mobile-column-tabs" id="mobileColumnTabs">
        <div class="mobile-column-tabs-inner">
            <button class="mobile-tab active" data-status="backlog">
                <span class="mobile-tab-label">Backlog</span>
                <span class="mobile-tab-count" data-count="backlog">0</span>
            </button>
            <button class="mobile-tab" data-status="queued">
                <span class="mobile-tab-label">Queue</span>
                <span class="mobile-tab-count" data-count="queued">0</span>
            </button>
            <button class="mobile-tab" data-status="progress">
                <span class="mobile-tab-label">Progress</span>
                <span class="mobile-tab-count" data-count="progress">0</span>
            </button>
            <button class="mobile-tab" data-status="review">
                <span class="mobile-tab-label">Review</span>
                <span class="mobile-tab-count" data-count="review">0</span>
            </button>
            <button class="mobile-tab" data-status="done">
                <span class="mobile-tab-label">Done</span>
                <span class="mobile-tab-count" data-count="done">0</span>
            </button>
            <button class="mobile-tab" data-status="blocked">
                <span class="mobile-tab-label">Blocked</span>
                <span class="mobile-tab-count" data-count="blocked">0</span>
            </button>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h3>Projects</h3>
                    <div class="sidebar-actions">
                        <button id="btnRefreshProjects" class="btn btn-small btn-secondary" title="Refresh projects">&#8635;</button>
                        <button id="btnScanProjects" class="btn btn-small btn-secondary" title="Scan folder">Scan</button>
                        <button id="btnAddProject" class="btn btn-small btn-add" title="Add project">+</button>
                    </div>
                </div>
                <div class="project-list">
                    <div class="project-item active" data-project-id="">
                        <span class="project-icon">&#128193;</span>
                        <span class="project-name">All Projects</span>
                    </div>
                    <!-- Projects loaded dynamically -->
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h3>Task Types</h3>
                    <button id="btnAddTaskType" class="btn btn-small btn-add" title="Add type">+</button>
                </div>
                <div class="task-type-list">
                    <!-- Task types loaded dynamically -->
                </div>
            </div>
        </aside>

        <!-- Sidebar Resize Handle -->
        <div class="sidebar-resize-handle" id="sidebarResizeHandle"></div>

        <main class="board">
            <div class="column mobile-active" data-status="backlog">
                <div class="column-header">
                    <h2>Backlog</h2>
                    <button class="btn btn-add" data-status="backlog">+</button>
                </div>
                <div class="tasks-container"></div>
            </div>

            <div class="column" data-status="queued">
                <div class="column-header">
                    <h2>Queue</h2>
                </div>
                <div class="tasks-container"></div>
            </div>

            <div class="column" data-status="progress">
                <div class="column-header">
                    <h2>In Progress</h2>
                </div>
                <div class="tasks-container"></div>
            </div>

            <div class="column" data-status="review">
                <div class="column-header">
                    <h2>Review</h2>
                </div>
                <div class="tasks-container"></div>
            </div>

            <div class="column" data-status="done">
                <div class="column-header">
                    <h2>Done</h2>
                </div>
                <div class="tasks-container"></div>
            </div>

            <div class="column" data-status="blocked">
                <div class="column-header">
                    <h2>Blocked</h2>
                </div>
                <div class="tasks-container"></div>
            </div>
        </main>
    </div>


    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Task</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="taskId">

                    <div class="form-group">
                        <label for="taskTitle">Title *</label>
                        <input type="text" id="taskTitle" required>
                    </div>

                    <div class="form-group">
                        <label for="taskDescription">Description (Markdown)</label>
                        <textarea id="taskDescription" rows="6" placeholder="What should be implemented?"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="taskCriteria">Acceptance Criteria</label>
                        <textarea id="taskCriteria" rows="4" placeholder="When is the task complete?"></textarea>
                    </div>

                    <!-- Attachments Section -->
                    <div class="form-group" id="attachmentsSection">
                        <label>Attachments</label>
                        <div id="attachmentDropZone" class="attachment-drop-zone compact">
                            <svg class="drop-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                            </svg>
                            <span class="drop-zone-text">Drop files or</span>
                            <label class="btn btn-secondary btn-small">
                                Browse
                                <input type="file" id="attachmentInput" multiple accept="image/png,image/jpeg,image/gif,image/webp,video/mp4,video/webm,video/quicktime" hidden>
                            </label>
                        </div>
                        <div id="attachmentList" class="attachment-list">
                            <!-- Attachments rendered here -->
                        </div>
                        <div id="pendingAttachmentList" class="attachment-list pending">
                            <!-- Pending attachments (before task save) rendered here -->
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskProject">Project</label>
                            <select id="taskProject">
                                <option value="">No project</option>
                                <!-- Projects loaded dynamically -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="taskType">Task Type</label>
                            <select id="taskType">
                                <option value="">No type</option>
                                <!-- Task types loaded dynamically -->
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskPriority">Priority</label>
                            <select id="taskPriority">
                                <option value="1">High</option>
                                <option value="2" selected>Medium</option>
                                <option value="3">Low</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="taskMaxIterations">Max Iterations</label>
                            <input type="number" id="taskMaxIterations" value="10" min="1" max="100">
                        </div>
                    </div>

                    <div class="form-group" id="projectDirGroup">
                        <label for="taskProjectDir">Project Directory</label>
                        <div class="path-input-row">
                            <input type="text" id="taskProjectDir" placeholder="Empty = use default">
                            <button type="button" id="btnBrowse" class="btn btn-secondary">Browse</button>
                        </div>
                    </div>

                    <!-- Branch info display (read-only, shown when task is running) -->
                    <div class="form-group hidden" id="branchInfoGroup">
                        <label>Current Branch</label>
                        <div class="branch-display">
                            <svg class="branch-icon" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                                <path d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.493 2.493 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25Zm-6 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Zm8.25-.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z"/>
                            </svg>
                            <span id="taskBranch">-</span>
                        </div>
                    </div>
                </form>

                <!-- RALPH Controls (shown when task is running) -->
                <div id="ralphControls" class="ralph-controls hidden">
                    <h3>RALPH Controls</h3>
                    <div class="ralph-buttons">
                        <button id="btnPause" class="btn btn-warning">Pause</button>
                        <button id="btnResume" class="btn btn-success hidden">Resume</button>
                        <button id="btnStop" class="btn btn-danger">Stop</button>
                    </div>
                </div>

                <!-- Feedback Section (shown for all states except backlog) -->
                <div id="feedbackSection" class="feedback-section hidden">
                    <div class="form-group">
                        <label for="feedbackInput" id="feedbackLabel">Feedback to Claude:</label>
                        <div class="feedback-row">
                            <textarea id="feedbackInput" rows="2" placeholder="Enter message..."></textarea>
                            <button id="btnFeedback" class="btn btn-primary">Send</button>
                        </div>
                        <p class="help-text" id="feedbackHelp">Send feedback to running process</p>
                    </div>
                </div>

                <!-- Log Section -->
                <div id="logSection" class="log-section hidden">
                    <div class="log-header">
                        <h3>Log</h3>
                        <span id="iterationBadge" class="badge">Iteration 0</span>
                        <div class="log-controls">
                            <input type="text" id="logSearch" class="log-search" placeholder="Search logs...">
                            <div class="log-filters">
                                <button class="filter-btn active" data-filter="all" title="Show all">All</button>
                                <button class="filter-btn" data-filter="errors" title="Errors only">‚ùå</button>
                                <button class="filter-btn" data-filter="tools" title="Tools only">üîß</button>
                                <button class="filter-btn" data-filter="hide-thinking" title="Hide thinking">üí≠</button>
                            </div>
                            <label class="auto-scroll-label">
                                <input type="checkbox" id="autoScroll" checked>
                                Auto-Scroll
                            </label>
                        </div>
                    </div>
                    <div id="logOutput" class="log-output">
                        <!-- Iterations will be rendered here -->
                    </div>
                </div>

                <!-- Error Display -->
                <div id="errorSection" class="error-section hidden">
                    <h3>Error</h3>
                    <p id="errorMessage"></p>
                </div>
            </div>

            <div class="modal-footer">
                <button id="btnDelete" class="btn btn-danger hidden">Delete</button>
                <button id="btnSave" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Folder Browser Modal -->
    <div id="folderModal" class="modal">
        <div class="modal-content folder-modal">
            <div class="modal-header">
                <h2>Select Folder</h2>
                <button class="close-btn folder-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="folder-nav">
                    <button id="btnParentDir" class="btn btn-secondary btn-small">&uarr; Up</button>
                    <input type="text" id="currentPath" class="path-display" readonly>
                </div>
                <div id="folderList" class="folder-list">
                    <!-- Folders will be loaded here -->
                </div>
                <div class="new-folder-section">
                    <div class="new-folder-row">
                        <input type="text" id="newFolderName" placeholder="New folder name...">
                        <button id="btnCreateFolder" class="btn btn-primary">Create</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCancelFolder" class="btn btn-secondary">Cancel</button>
                <button id="btnSelectFolder" class="btn btn-primary">Select</button>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 id="projectModalTitle">New Project</h2>
                <button class="close-btn project-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm">
                    <input type="hidden" id="projectId">

                    <div class="form-group">
                        <label for="projectName">Name *</label>
                        <input type="text" id="projectName" required placeholder="Project name">
                    </div>

                    <div class="form-group">
                        <label for="projectPath">Path *</label>
                        <div class="path-input-row">
                            <input type="text" id="projectPath" required placeholder="/path/to/project">
                            <button type="button" id="btnBrowseProject" class="btn btn-secondary">Browse</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="projectDescription">Description</label>
                        <textarea id="projectDescription" rows="3" placeholder="Optional description"></textarea>
                    </div>

                    <!-- Branch Protection Rules -->
                    <div class="form-group">
                        <label>Branch Protection Rules</label>
                        <p class="help-text">Branches that RALPH is never allowed to push to</p>
                        <div class="branch-rules-list" id="branchRulesList">
                            <!-- Rules loaded dynamically -->
                        </div>
                        <div class="add-rule-row">
                            <input type="text" id="newBranchRule" placeholder="e.g. main, master, release/*">
                            <button type="button" id="btnAddBranchRule" class="btn btn-secondary btn-small">Add</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnDeleteProject" class="btn btn-danger hidden">Delete</button>
                <button id="btnSaveProject" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Scan Projects Modal -->
    <div id="scanModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Scan Projects</h2>
                <button class="close-btn scan-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="scanBasePath">Base Directory</label>
                    <div class="path-input-row">
                        <input type="text" id="scanBasePath" placeholder="/path/to/folder">
                        <button type="button" id="btnBrowseScan" class="btn btn-secondary">Browse</button>
                    </div>
                    <p class="help-text">Scans for Git repositories in this directory</p>
                </div>
                <div class="form-group">
                    <label for="scanDepth">Search Depth</label>
                    <select id="scanDepth">
                        <option value="2">2 levels</option>
                        <option value="3">3 levels</option>
                        <option value="4" selected>4 levels</option>
                        <option value="5">5 levels</option>
                        <option value="6">6 levels</option>
                        <option value="8">8 levels</option>
                    </select>
                </div>
                <div id="scanResults" class="scan-results hidden">
                    <h4>Found Repositories:</h4>
                    <div id="scanResultsList" class="scan-results-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCancelScan" class="btn btn-secondary">Cancel</button>
                <button id="btnStartScan" class="btn btn-primary">Scan</button>
                <button id="btnImportScan" class="btn btn-success hidden">Import</button>
            </div>
        </div>
    </div>

    <!-- Task Type Modal -->
    <div id="taskTypeModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 id="taskTypeModalTitle">New Task Type</h2>
                <button class="close-btn tasktype-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskTypeForm">
                    <input type="hidden" id="taskTypeId">

                    <div class="form-group">
                        <label for="taskTypeName">Name *</label>
                        <input type="text" id="taskTypeName" required placeholder="e.g. Feature, Bug, Refactor">
                    </div>

                    <div class="form-group">
                        <label for="taskTypeColor">Color</label>
                        <div class="color-picker-row">
                            <input type="color" id="taskTypeColor" value="#58a6ff">
                            <span id="taskTypeColorPreview" class="color-preview" style="background-color: #58a6ff;"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnDeleteTaskType" class="btn btn-danger hidden">Delete</button>
                <button id="btnSaveTaskType" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-btn settings-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="settings-tab active" data-tab="general">General</button>
                    <button class="settings-tab" data-tab="appearance">Appearance</button>
                    <button class="settings-tab" data-tab="github">GitHub</button>
                    <button class="settings-tab" data-tab="tasks">Tasks</button>
                </div>

                <!-- General Settings -->
                <div class="settings-content active" id="settings-general">
                    <div class="form-group">
                        <label for="settingsProjectDir">Default Project Directory</label>
                        <div class="path-input-row">
                            <input type="text" id="settingsProjectDir" placeholder="/path/to/project">
                            <button type="button" id="btnBrowseSettingsDir" class="btn btn-secondary">Browse</button>
                        </div>
                        <p class="help-text">Used as default when no project is selected</p>
                    </div>

                    <div class="form-group">
                        <label for="settingsClaudeCommand">Claude Command Path</label>
                        <input type="text" id="settingsClaudeCommand" placeholder="claude">
                        <p class="help-text">Path to Claude CLI command (default: claude)</p>
                    </div>

                    <div class="form-group">
                        <label for="settingsMaxIterations">Max Iterations (Default)</label>
                        <input type="number" id="settingsMaxIterations" value="10" min="1" max="100">
                        <p class="help-text">Maximum number of RALPH iterations for new tasks</p>
                    </div>
                </div>

                <!-- Appearance Settings -->
                <div class="settings-content" id="settings-appearance">
                    <div class="form-group">
                        <label>Color Scheme</label>
                        <div class="theme-selector">
                            <label class="theme-option">
                                <input type="radio" name="themeChoice" value="dark" checked>
                                <span class="theme-preview theme-preview-dark">
                                    <span class="theme-icon">&#127769;</span>
                                    <span class="theme-label">Dark</span>
                                </span>
                            </label>
                            <label class="theme-option">
                                <input type="radio" name="themeChoice" value="light">
                                <span class="theme-preview theme-preview-light">
                                    <span class="theme-icon">&#9728;</span>
                                    <span class="theme-label">Light</span>
                                </span>
                            </label>
                            <label class="theme-option">
                                <input type="radio" name="themeChoice" value="system">
                                <span class="theme-preview theme-preview-system">
                                    <span class="theme-icon">&#128187;</span>
                                    <span class="theme-label">System</span>
                                </span>
                            </label>
                        </div>
                        <p class="help-text">Choose between dark, light, or system-based color scheme</p>
                    </div>
                </div>

                <!-- GitHub Settings -->
                <div class="settings-content" id="settings-github">
                    <div class="form-group">
                        <label for="settingsGithubToken">Personal Access Token (PAT)</label>
                        <div class="token-input-row">
                            <input type="password" id="settingsGithubToken" placeholder="ghp_xxxxxxxxxxxx">
                            <button type="button" id="btnToggleToken" class="btn btn-secondary btn-small">Show</button>
                        </div>
                        <p class="help-text">
                            Generate token at <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings</a>
                            with 'repo' scope.
                        </p>
                    </div>

                    <div id="settingsGithubStatus" class="github-status hidden">
                        <span class="github-status-icon"></span>
                        <span class="github-status-text"></span>
                    </div>

                    <div class="form-group">
                        <label for="settingsDefaultBranch">Default Merge Branch</label>
                        <input type="text" id="settingsDefaultBranch" placeholder="main">
                        <p class="help-text">Target branch for merging completed tasks (e.g., main, develop)</p>
                    </div>
                </div>

                <!-- Tasks Settings -->
                <div class="settings-content" id="settings-tasks">
                    <div class="form-group">
                        <label for="settingsDefaultPriority">Default Priority</label>
                        <select id="settingsDefaultPriority">
                            <option value="1">High</option>
                            <option value="2" selected>Medium</option>
                            <option value="3">Low</option>
                        </select>
                        <p class="help-text">Default priority for new tasks</p>
                    </div>

                    <div class="form-group">
                        <label for="settingsAutoArchive">Auto-archive after days</label>
                        <input type="number" id="settingsAutoArchive" value="0" min="0" max="365">
                        <p class="help-text">Automatically archive tasks in Done after X days (0 = disabled)</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnValidateSettings" class="btn btn-secondary">Validate token</button>
                <button id="btnSaveSettings" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- GitHub Settings Modal -->
    <div id="githubModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>GitHub Settings</h2>
                <button class="close-btn github-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="githubToken">Personal Access Token (PAT)</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                    <p class="help-text">
                        Generate a token at <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings</a>
                        with 'repo' scope.
                    </p>
                </div>
                <div id="githubStatus" class="github-status hidden">
                    <span class="github-status-icon"></span>
                    <span class="github-status-text"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnValidateGithub" class="btn btn-secondary">Validate</button>
                <button id="btnSaveGithub" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Create GitHub Repo Modal -->
    <div id="createRepoModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Create GitHub Repository</h2>
                <button class="close-btn repo-close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="createRepoProjectId">
                <div class="form-group">
                    <label for="repoName">Repository Name</label>
                    <input type="text" id="repoName" placeholder="my-project">
                </div>
                <div class="form-group">
                    <label for="repoDescription">Description (optional)</label>
                    <input type="text" id="repoDescription" placeholder="A brief description">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="repoPrivate">
                        Make repository private
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCancelRepo" class="btn btn-secondary">Cancel</button>
                <button id="btnCreateRepo" class="btn btn-primary">Create Repository</button>
            </div>
        </div>
    </div>

    <!-- Deployment Confirmation Modal -->
    <div id="deployModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Deploy to GitHub</h2>
                <button class="close-btn deploy-close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deployTaskId">
                <p id="deployTaskTitle" class="deploy-task-title"></p>
                <div class="form-group">
                    <label for="deployCommitMessage">Commit Message</label>
                    <input type="text" id="deployCommitMessage" placeholder="Deploy: task title">
                </div>
                <div id="deployStatus" class="deploy-status hidden">
                    <div class="deploy-progress">
                        <span class="spinner"></span>
                        <span class="deploy-progress-text">Deploying...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCancelDeploy" class="btn btn-secondary">Cancel</button>
                <button id="btnConfirmDeploy" class="btn btn-success">Deploy</button>
            </div>
        </div>
    </div>

    <!-- Create PR Modal -->
    <div id="createPRModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Create Pull Request</h2>
                <button class="close-btn create-pr-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="prProjectSelect">Project</label>
                    <select id="prProjectSelect" class="form-select">
                        <option value="">Select a project...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="prFromBranch">From Branch</label>
                    <select id="prFromBranch" class="form-select">
                        <option value="">Select branch...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="prToBranch">To Branch</label>
                    <select id="prToBranch" class="form-select">
                        <option value="">Select branch...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="prTitle">PR Title</label>
                    <input type="text" id="prTitle" placeholder="Pull request title...">
                </div>
                <div id="prStatus" class="pr-status hidden">
                    <div class="pr-progress">
                        <span class="spinner"></span>
                        <span class="pr-progress-text">Creating PR...</span>
                    </div>
                </div>
                <div id="prResult" class="pr-result hidden">
                    <div class="pr-success">
                        <span class="pr-success-icon">&#10003;</span>
                        <span class="pr-success-text">PR created successfully!</span>
                    </div>
                    <a id="prResultLink" href="#" target="_blank" class="btn btn-primary pr-link">
                        View PR
                    </a>
                </div>
                <div id="prError" class="pr-error hidden">
                    <span class="pr-error-text"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCancelPR" class="btn btn-secondary">Cancel</button>
                <button id="btnConfirmPR" class="btn btn-primary">Create PR</button>
            </div>
        </div>
    </div>

    <!-- Search Modal (Cmd+K) -->
    <div id="searchModal" class="search-modal">
        <div class="search-modal-content">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" id="searchInput" class="search-input" placeholder="Search tasks..." autocomplete="off">
                <kbd class="search-shortcut">ESC</kbd>
            </div>
            <div id="searchResults" class="search-results">
                <!-- Search results will be rendered here -->
            </div>
            <div id="searchEmpty" class="search-empty hidden">
                <span>No tasks found</span>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- WebSocket Reconnect Banner -->
    <div id="reconnectBanner" class="reconnect-banner hidden">
        <span>Connection lost</span>
        <button id="btnReconnect" class="btn btn-small">Reconnect</button>
    </div>

    <!-- Lightbox for viewing attachments -->
    <div id="lightbox" class="lightbox hidden">
        <div class="lightbox-content">
            <button class="lightbox-close">&times;</button>
            <button class="lightbox-prev">&lsaquo;</button>
            <button class="lightbox-next">&rsaquo;</button>
            <div class="lightbox-media">
                <img id="lightboxImage" class="hidden" alt="">
                <video id="lightboxVideo" class="hidden" controls></video>
            </div>
            <div class="lightbox-info">
                <span id="lightboxFilename"></span>
                <span id="lightboxCounter"></span>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
